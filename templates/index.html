<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="100챌린지">
    <meta name="theme-color" content="#4C1D95">
    <meta name="description" content="매일 100개 푸시업 챌린지 - 함께 운동하고 기록하세요">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <title>100챌린지</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #5B21B6;
            --primary-dark: #4C1D95;
            --primary-light: #EDE9FE;
            --primary-gradient: linear-gradient(135deg, #4C1D95 0%, #7C3AED 100%);
            --success: #10B981;
            --success-light: #ECFDF5;
            --danger: #EF4444;
            --danger-light: #FEF2F2;
            --warning: #F59E0B;
            --bg: #F4F6F9;
            --card: #FFFFFF;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border: #E2E8F0;
            --border-light: rgba(0,0,0,0.04);
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-400: #94A3B8;
            --gray-600: #475569;
            --shadow-card: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
            --shadow-xl: 0 16px 48px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-lg: 20px;
            --radius-xl: 24px;
        }

        html {
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 20px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #2E1065 0%, #4C1D95 100%);
            border-bottom: none;
            padding: 28px 20px 24px;
            margin: 0 -20px;
            text-align: center;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            margin-bottom: 6px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }

        .header-icon .logo-text {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: #FFFFFF;
            letter-spacing: -1px;
            line-height: 1;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: #FFFFFF;
            letter-spacing: -0.03em;
        }

        .header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 2px;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            padding: 32px 0;
        }

        .login-card {
            background: var(--card);
            border-radius: var(--radius-xl);
            padding: 40px 28px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .login-card h2 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-card .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 0.925rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 16px 20px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 1.05rem;
            font-weight: 500;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            transition: all 0.2s ease;
            background: #F8FAFC;
            color: var(--text-primary);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(91, 33, 182, 0.12);
        }

        .input-group input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1.05rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(91, 33, 182, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(91, 33, 182, 0.2);
        }

        /* ===== MAIN SCREEN ===== */
        .main-screen {
            display: none;
            padding-bottom: 40px;
        }

        .main-screen.active {
            display: block;
        }

        /* ===== USER BAR ===== */
        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 16px;
            margin-bottom: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: var(--primary-gradient);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(91, 33, 182, 0.25);
        }

        .user-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--text-primary);
        }

        .user-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .user-bar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-btn {
            background: var(--card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            font-size: 1.15rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-btn:active {
            background: var(--bg);
            transform: scale(0.95);
        }

        .logout-btn {
            background: var(--card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:active {
            background: var(--bg);
            transform: scale(0.97);
        }

        /* ===== MONTH SELECT ===== */
        .month-select-wrapper {
            margin-bottom: 16px;
        }

        .month-select {
            width: 100%;
            padding: 14px 48px 14px 20px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: var(--card);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394A3B8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .month-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(91, 33, 182, 0.12);
        }

        /* ===== STATS CARD (Dark Premium) ===== */
        .stats-card {
            background: linear-gradient(135deg, #2E1065 0%, #4C1D95 50%, #6D28D9 100%);
            border-radius: var(--radius-lg);
            padding: 24px;
            color: white;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(46, 16, 101, 0.4);
            position: relative;
            overflow: hidden;
        }

        .stats-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.2) 0%, transparent 70%);
            pointer-events: none;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .stats-label {
            font-size: 0.825rem;
            opacity: 0.7;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stats-amount {
            font-family: 'Inter', sans-serif;
            font-size: 2.25rem;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .stats-badge {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 24px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 18px;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 1;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: 'Inter', sans-serif;
            font-size: 1.35rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.725rem;
            opacity: 0.6;
            margin-top: 2px;
            font-weight: 500;
        }

        .penalty-account {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid rgba(255,255,255,0.08);
            position: relative;
            z-index: 1;
        }

        .penalty-account-text {
            font-size: 0.725rem;
            opacity: 0.5;
        }

        .penalty-account-copy {
            background: rgba(255,255,255,0.12);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .penalty-account-copy:active {
            background: rgba(255,255,255,0.25);
            transform: scale(0.92);
        }

        .penalty-account-copy svg {
            width: 14px;
            height: 14px;
        }

        /* ===== TODAY ACTION ===== */
        .today-action {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            transition: all 0.25s ease;
        }

        .today-action.completed {
            border: 1.5px solid var(--success);
            background: var(--success-light);
        }

        .today-action.not-workday {
            opacity: 0.75;
        }

        .today-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 18px;
        }

        .today-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s ease;
            border: 1px solid rgba(91, 33, 182, 0.08);
        }

        .today-action.completed .today-icon {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-color: rgba(16, 185, 129, 0.1);
        }

        .today-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .today-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .today-btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 1.05rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(91, 33, 182, 0.25);
        }

        .today-btn:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(91, 33, 182, 0.15);
        }

        .today-action.completed .today-btn {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        }

        .today-action.not-workday .today-btn {
            background: #CBD5E1;
            cursor: default;
            box-shadow: none;
        }

        /* ===== CALENDAR ===== */
        .calendar-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            border-top: 3px solid var(--primary);
        }

        .calendar-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: 8px;
        }

        .calendar-header span {
            text-align: center;
            font-size: 0.775rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .calendar-header span:first-child {
            color: var(--danger);
        }

        .calendar-header span:last-child {
            color: var(--primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            background: #F8FAFC;
            color: var(--text-primary);
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.today {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 700;
            box-shadow: inset 0 0 0 2px var(--primary);
        }

        .calendar-day.completed {
            background: var(--success);
            color: white;
        }

        .calendar-day.completed::after {
            content: '';
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
        }

        .calendar-day.sunday {
            color: var(--danger);
            background: var(--danger-light);
        }

        .calendar-day.saturday {
            color: var(--primary);
            background: var(--primary-light);
        }

        .calendar-day.holiday {
            color: var(--danger);
            background: var(--danger-light);
        }

        .calendar-day.missed {
            background: var(--danger-light);
            color: var(--danger);
        }

        .calendar-day.future {
            color: #CBD5E1;
            background: transparent;
            cursor: default;
        }

        .calendar-day:active:not(.empty):not(.future) {
            transform: scale(0.9);
        }

        /* Legend */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 4px;
        }

        .legend-dot.completed { background: var(--success); }
        .legend-dot.missed { background: var(--danger-light); border: 1.5px solid var(--danger); }
        .legend-dot.holiday { background: var(--danger-light); }

        /* ===== RANKINGS ===== */
        .ranking-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            border-top: 3px solid var(--primary);
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ranking-header h3 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .ranking-list {
            list-style: none;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            background: #F8FAFC;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .ranking-item:last-child {
            margin-bottom: 0;
        }

        .ranking-item.rank-1 {
            background: #FFFBEB;
            border-left-color: #F59E0B;
        }

        .ranking-item.rank-2 {
            background: #F8FAFC;
            border-left-color: #94A3B8;
        }

        .ranking-item.rank-3 {
            background: #FFF7ED;
            border-left-color: #F97316;
        }

        .ranking-item.is-me {
            border-left-color: var(--primary);
            background: var(--primary-light);
        }

        .ranking-item.hidden {
            display: none;
        }

        .rank-badge {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-right: 14px;
            box-shadow: var(--shadow-sm);
        }

        .ranking-item.rank-1 .rank-badge {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
        }

        .ranking-item.rank-2 .rank-badge {
            background: linear-gradient(135deg, #94A3B8 0%, #64748B 100%);
            color: white;
        }

        .ranking-item.rank-3 .rank-badge {
            background: linear-gradient(135deg, #FB923C 0%, #EA580C 100%);
            color: white;
        }

        .rank-info {
            flex: 1;
            min-width: 0;
        }

        .rank-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rank-stats {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .rank-penalty {
            text-align: right;
        }

        .penalty-amount {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            font-size: 1.05rem;
            color: var(--danger);
        }

        .penalty-amount.zero {
            color: var(--success);
        }

        .penalty-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Ranking Toggle */
        .ranking-toggle {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #F1F5F9;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .ranking-toggle:active {
            background: var(--border);
            transform: scale(0.98);
        }

        .ranking-toggle .arrow {
            transition: transform 0.3s ease;
            font-size: 0.75rem;
        }

        .ranking-toggle.expanded .arrow {
            transform: rotate(180deg);
        }

        /* ===== EVENT NOTICE BAR ===== */
        .notice-bar {
            background: linear-gradient(135deg, #2E1065 0%, #5B21B6 100%);
            border-radius: var(--radius);
            padding: 14px 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 12px rgba(46, 16, 101, 0.25);
            position: relative;
            overflow: hidden;
        }

        .notice-bar::after {
            content: '';
            position: absolute;
            right: -20px;
            top: -20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.25) 0%, transparent 70%);
            pointer-events: none;
        }

        .notice-bar:active {
            transform: scale(0.98);
        }

        .notice-bar-badge {
            background: rgba(255,255,255,0.18);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 800;
            color: #E9D5FF;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .notice-bar-text {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notice-bar-arrow {
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .notice-bar.hidden {
            display: none;
        }

        /* ===== EVENT DETAIL SCREEN ===== */
        .event-screen {
            display: none;
            padding-bottom: 40px;
        }

        .event-screen.active {
            display: block;
        }

        .event-back-bar {
            display: flex;
            align-items: center;
            padding: 20px 0 16px;
        }

        .event-back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--card);
            border: 1px solid var(--border);
            padding: 10px 18px;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-back-btn:active {
            background: var(--bg);
            transform: scale(0.97);
        }

        .event-detail-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            margin-bottom: 16px;
        }

        .event-detail-hero {
            background: linear-gradient(135deg, #2E1065 0%, #5B21B6 50%, #7C3AED 100%);
            padding: 32px 24px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .event-detail-hero::after {
            content: '';
            position: absolute;
            top: -40%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(167, 139, 250, 0.2) 0%, transparent 70%);
            pointer-events: none;
        }

        .event-dday-large {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: -0.04em;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .event-title-large {
            font-size: 1.15rem;
            font-weight: 700;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .event-date-info {
            font-size: 0.825rem;
            opacity: 0.6;
            margin-top: 8px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .event-action-area {
            padding: 24px;
        }

        .event-join-btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 1.05rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(91, 33, 182, 0.25);
        }

        .event-join-btn:active {
            transform: scale(0.97);
        }

        .event-join-btn.joined {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
        }

        .event-participants-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
        }

        .event-participants-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .event-participants-header h3 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .event-participants-count {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
            background: var(--primary-light);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .event-participant-list {
            list-style: none;
        }

        .event-participant-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            background: #F8FAFC;
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .event-participant-item:last-child {
            margin-bottom: 0;
        }

        .event-participant-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .event-participant-name {
            flex: 1;
            font-weight: 600;
            font-size: 0.925rem;
            color: var(--text-primary);
        }

        .event-participant-date {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .event-participant-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .event-participant-item.is-me {
            background: var(--primary-light);
            box-shadow: inset 3px 0 0 var(--primary);
        }

        /* ===== ADMIN EVENT FORM ===== */
        .admin-event-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .admin-event-form input {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: #F8FAFC;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .admin-event-form input:focus {
            outline: none;
            border-color: var(--primary);
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(91, 33, 182, 0.1);
        }

        .admin-event-actions {
            display: flex;
            gap: 8px;
        }

        .admin-event-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .admin-event-actions button:active {
            transform: scale(0.96);
        }

        .admin-event-current {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--primary-light);
            border-radius: var(--radius);
            margin-bottom: 14px;
            border: 1px solid rgba(91, 33, 182, 0.15);
        }

        .admin-event-current-info {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary-dark);
        }

        .admin-event-current-info span {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: 2px;
        }

        /* ===== ASSETS ===== */
        .asset-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 16px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-light);
            border-top: 3px solid var(--primary);
        }

        .asset-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .asset-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .asset-header h3 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .asset-refresh-time {
            font-family: 'Inter', sans-serif;
            font-size: 0.725rem;
            color: var(--text-muted);
        }

        .asset-total {
            background: linear-gradient(135deg, #059669 0%, #10B981 50%, #34D399 100%);
            border-radius: var(--radius);
            padding: 22px 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        }

        .asset-total-label {
            font-size: 0.825rem;
            opacity: 0.85;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .asset-total-amount {
            font-family: 'Inter', sans-serif;
            font-size: 1.85rem;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .asset-section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.825rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            margin-top: 20px;
        }

        .asset-update-info {
            font-family: 'Inter', sans-serif;
            font-size: 0.675rem;
            font-weight: 400;
            color: var(--text-muted);
        }

        .exchange-rate-info {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #F8FAFC;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stock-list {
            list-style: none;
        }

        .stock-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .stock-symbol {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .stock-shares {
            font-family: 'Inter', sans-serif;
            font-size: 0.775rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .stock-right {
            text-align: right;
        }

        .stock-value {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 0.925rem;
            color: var(--text-primary);
        }

        .stock-change {
            font-family: 'Inter', sans-serif;
            font-size: 0.775rem;
            font-weight: 600;
            margin-top: 2px;
        }

        .stock-change.positive {
            color: var(--danger);
        }

        .stock-change.negative {
            color: #3B82F6;
        }

        .stock-change.zero {
            color: var(--text-muted);
        }

        .cash-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
        }

        .cash-label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .cash-amount {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .asset-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* ===== PWA BANNER ===== */
        .pwa-banner {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            max-width: 480px;
            margin: 0 auto;
            background: var(--card);
            padding: 18px 20px;
            padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px));
            box-shadow: var(--shadow-xl);
            transform: translateY(calc(100% + 40px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .pwa-banner.show {
            transform: translateY(0);
        }

        .pwa-banner-content {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .pwa-banner-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #4C1D95 0%, #7C3AED 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(91, 33, 182, 0.25);
        }

        .pwa-banner-icon .logo-text {
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 900;
            color: #FFFFFF;
            letter-spacing: -1px;
            line-height: 1;
        }

        .pwa-banner-text {
            flex: 1;
            min-width: 0;
        }

        .pwa-banner-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .pwa-banner-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .pwa-banner-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-shrink: 0;
        }

        .pwa-install-btn {
            padding: 10px 18px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(91, 33, 182, 0.25);
        }

        .pwa-install-btn:active {
            transform: scale(0.95);
        }

        .pwa-dismiss-btn {
            padding: 6px 12px;
            background: transparent;
            color: var(--text-muted);
            border: none;
            font-size: 0.75rem;
            font-weight: 500;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            text-align: center;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: 14px 28px;
            border-radius: 100px;
            font-size: 0.925rem;
            font-weight: 600;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            z-index: 3000;
            box-shadow: var(--shadow-xl);
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            max-width: 90vw;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== LOADING / EMPTY ===== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 20px;
            color: var(--text-muted);
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-bottom: 14px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        /* ===== MODAL OVERLAY ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* ===== BOTTOM SHEET ===== */
        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            z-index: 2001;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 85vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .bottom-sheet.show {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: #CBD5E1;
            border-radius: 2px;
            margin: 12px auto;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sheet-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sheet-close {
            background: #F1F5F9;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .sheet-close:active {
            background: var(--border);
            transform: scale(0.92);
        }

        .sheet-body {
            padding: 20px 24px;
        }

        .sheet-section {
            margin-bottom: 28px;
        }

        .sheet-section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 14px;
        }

        .admin-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .admin-form input {
            flex: 1;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: #F8FAFC;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .admin-form input:focus {
            outline: none;
            border-color: var(--primary);
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(91, 33, 182, 0.1);
        }

        .admin-form button {
            padding: 12px 18px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .admin-form button:active {
            transform: scale(0.95);
        }

        .admin-stock-list {
            list-style: none;
        }

        .admin-stock-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: #F8FAFC;
            border-radius: var(--radius);
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .admin-stock-info {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .admin-stock-actions {
            display: flex;
            gap: 8px;
        }

        .admin-stock-actions button {
            padding: 7px 14px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .admin-stock-actions button:active {
            transform: scale(0.95);
        }

        .btn-edit {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .btn-delete {
            background: var(--danger-light);
            color: var(--danger);
        }

        .cash-form {
            display: flex;
            gap: 8px;
        }

        .cash-form input {
            flex: 1;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: #F8FAFC;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .cash-form input:focus {
            outline: none;
            border-color: var(--primary);
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(91, 33, 182, 0.1);
        }

        .cash-form button {
            padding: 12px 18px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .cash-form button:active {
            transform: scale(0.95);
        }

        .admin-hint {
            font-size: 0.775rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .btn-save-all {
            width: 100%;
            padding: 16px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1.025rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(91, 33, 182, 0.25);
            transition: all 0.2s ease;
        }

        .btn-save-all:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(91, 33, 182, 0.15);
        }

        .save-all-result {
            padding: 12px 14px;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .save-all-result.success {
            display: block;
            background: var(--success-light);
            color: #065F46;
        }

        .save-all-result.error {
            display: block;
            background: var(--danger-light);
            color: var(--danger);
        }

        /* ===== API KEY ===== */
        .api-key-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: #F8FAFC;
            border-radius: var(--radius);
            margin-bottom: 14px;
            border: 1px solid var(--border);
        }

        .api-key-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .api-key-dot.connected {
            background: var(--success);
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.4);
        }

        .api-key-dot.disconnected {
            background: var(--danger);
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
        }

        .api-key-status-text {
            font-size: 0.825rem;
            color: var(--text-secondary);
            flex: 1;
            word-break: break-all;
        }

        .api-key-form {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .api-key-form input {
            flex: 1;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-family: 'Inter', monospace;
            background: #F8FAFC;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .api-key-form input:focus {
            outline: none;
            border-color: var(--primary);
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(91, 33, 182, 0.1);
        }

        .api-key-actions {
            display: flex;
            gap: 8px;
        }

        .api-key-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 700;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .api-key-actions button:active {
            transform: scale(0.96);
        }

        .btn-test {
            background: #F1F5F9;
            color: var(--text-primary);
        }

        .btn-test:active {
            background: var(--border);
        }

        .btn-save-key {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .btn-save-key:active {
            opacity: 0.9;
        }

        .test-result {
            padding: 12px 14px;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
            display: none;
        }

        .test-result.success {
            display: block;
            background: var(--success-light);
            color: #065F46;
        }

        .test-result.error {
            display: block;
            background: var(--danger-light);
            color: var(--danger);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeInUp 0.4s ease-out;
        }

        /* ===== SCROLLBAR ===== */
        .bottom-sheet::-webkit-scrollbar {
            width: 4px;
        }

        .bottom-sheet::-webkit-scrollbar-track {
            background: transparent;
        }

        .bottom-sheet::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="header-icon">
                    <span class="logo-text">100</span>
                </div>
                <h1>100챌린지</h1>
            </div>
            <p>매일의 도전, 매일의 성장</p>
        </div>

        <!-- 로그인 화면 -->
        <div class="login-screen" id="loginScreen">
            <div class="login-card fade-in">
                <h2>환영합니다!</h2>
                <p class="subtitle">이름을 입력하고 챌린지에 참여하세요</p>
                <div class="input-group">
                    <label for="nameInput">이름</label>
                    <input type="text" id="nameInput" placeholder="홍길동" autocomplete="off" autocapitalize="off">
                </div>
                <button class="btn" onclick="login()">시작하기</button>
            </div>
        </div>

        <!-- 메인 화면 -->
        <div class="main-screen" id="mainScreen">
            <div class="user-bar">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">홍</div>
                    <div>
                        <div class="user-name" id="userName">홍길동</div>
                        <div class="user-status">챌린지 진행중</div>
                    </div>
                </div>
                <div class="user-bar-actions">
                    <button class="admin-btn" id="adminBtn" onclick="openAdminSheet()" style="display:none;" title="자산 관리">&#9881;</button>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 공지/이벤트 바 -->
            <div class="notice-bar hidden" id="noticeBar" onclick="showEventScreen()">
                <div class="notice-bar-badge" id="noticeDday">D-0</div>
                <div class="notice-bar-text" id="noticeText">이벤트 없음</div>
                <div class="notice-bar-arrow">&#8250;</div>
            </div>

            <div class="month-select-wrapper">
                <select class="month-select" id="monthSelect" onchange="loadCalendar()">
                </select>
            </div>

            <div class="stats-card fade-in">
                <div class="stats-header">
                    <div>
                        <div class="stats-label">이번 달 벌금</div>
                        <div class="stats-amount" id="penaltyAmount">₩0</div>
                    </div>
                    <div class="stats-badge" id="completionBadge">0%</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="completedDays">0</div>
                        <div class="stat-label">완료</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="missedDays">0</div>
                        <div class="stat-label">미완료</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalWorkdays">0</div>
                        <div class="stat-label">총 평일</div>
                    </div>
                </div>
                <div class="penalty-account">
                    <span class="penalty-account-text">벌금계좌:(카카오)7942-14-57728 김병석</span>
                    <button class="penalty-account-copy" onclick="copyAccount()" title="계좌번호 복사">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="today-action" id="todayAction">
                <div class="today-header">
                    <div class="today-icon" id="todayIcon">📅</div>
                    <div>
                        <div class="today-title" id="todayTitle">오늘의 푸시업</div>
                        <div class="today-date" id="todayDate"></div>
                    </div>
                </div>
                <button class="today-btn" id="todayBtn" onclick="toggleToday()">
                    100개 완료하기
                </button>
            </div>

            <div class="calendar-card fade-in">
                <div class="calendar-title">이번 달 기록</div>
                <div class="calendar-header">
                    <span>일</span>
                    <span>월</span>
                    <span>화</span>
                    <span>수</span>
                    <span>목</span>
                    <span>금</span>
                    <span>토</span>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                </div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-dot completed"></div>
                        <span>완료</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot missed"></div>
                        <span>미완료</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot holiday"></div>
                        <span>휴일</span>
                    </div>
                </div>
            </div>

            <div class="ranking-card fade-in">
                <div class="ranking-header">
                    <span>🏆</span>
                    <h3>명예의 전당</h3>
                </div>
                <ul class="ranking-list" id="rankingList">
                    <li class="loading">
                        <div class="spinner"></div>
                        <span>로딩 중...</span>
                    </li>
                </ul>
            </div>

            <div class="asset-card fade-in" id="assetCard">
                <div class="asset-header">
                    <div class="asset-header-left">
                        <span>💰</span>
                        <h3>그룹 보유자산</h3>
                    </div>
                    <span class="asset-refresh-time" id="assetRefreshTime"></span>
                </div>
                <div class="asset-total">
                    <div class="asset-total-label">총 자산</div>
                    <div class="asset-total-amount" id="assetTotalAmount">₩0</div>
                </div>
                <div class="asset-section-title">
                    보유 주식
                    <span class="asset-update-info" id="stockUpdateTime"></span>
                </div>
                <div class="exchange-rate-info" id="exchangeRateInfo"></div>
                <ul class="stock-list" id="stockList">
                    <li class="asset-empty">등록된 종목이 없습니다</li>
                </ul>
                <div class="asset-section-title">보유 현금</div>
                <div class="cash-row">
                    <span class="cash-label">KRW</span>
                    <span class="cash-amount" id="cashAmount">₩0</span>
                </div>
            </div>
        </div>

        <!-- 이벤트 상세 화면 -->
        <div class="event-screen" id="eventScreen">
            <div class="event-back-bar">
                <button class="event-back-btn" onclick="hideEventScreen()">&#8249; 홈으로 가기</button>
            </div>
            <div class="event-detail-card fade-in">
                <div class="event-detail-hero">
                    <div class="event-dday-large" id="eventDdayLarge">D-0</div>
                    <div class="event-title-large" id="eventTitleLarge">이벤트</div>
                    <div class="event-date-info" id="eventDateInfo"></div>
                </div>
                <div class="event-action-area">
                    <button class="event-join-btn" id="eventJoinBtn" onclick="toggleEventJoin()">참석하기</button>
                </div>
            </div>
            <div class="event-participants-card fade-in">
                <div class="event-participants-header">
                    <h3>참석 명단</h3>
                    <span class="event-participants-count" id="eventParticipantCount">0명</span>
                </div>
                <ul class="event-participant-list" id="eventParticipantList">
                    <li class="event-participant-empty">아직 참석자가 없습니다</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- PWA 설치 배너 -->
    <div class="pwa-banner" id="pwaBanner">
        <div class="pwa-banner-content">
            <div class="pwa-banner-icon">
                <span class="logo-text">100</span>
            </div>
            <div class="pwa-banner-text">
                <div class="pwa-banner-title">앱으로 설치하기</div>
                <div class="pwa-banner-desc">홈 화면에 추가하고 더 빠르게 접속하세요</div>
            </div>
            <div class="pwa-banner-actions">
                <button class="pwa-install-btn" id="pwaInstallBtn">설치</button>
                <button class="pwa-dismiss-btn" id="pwaDismissBtn">나중에</button>
            </div>
        </div>
    </div>

    <!-- 관리자 바텀시트 -->
    <div class="modal-overlay" id="adminOverlay" onclick="closeAdminSheet()"></div>
    <div class="bottom-sheet" id="adminSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <span class="sheet-title">자산 관리</span>
            <button class="sheet-close" onclick="closeAdminSheet()">&times;</button>
        </div>
        <div class="sheet-body">
            <div class="sheet-section" id="apiKeySection">
                <div class="sheet-section-title">Finnhub API 키</div>
                <div class="api-key-status" id="apiKeyStatus">
                    <div class="api-key-dot disconnected" id="apiKeyDot"></div>
                    <span class="api-key-status-text" id="apiKeyStatusText">키 미설정</span>
                </div>
                <div class="api-key-form">
                    <input type="password" id="apiKeyInput" placeholder="API 키 입력">
                </div>
                <div class="api-key-actions">
                    <button class="btn-test" onclick="testFinnhubKey()">연결 확인</button>
                    <button class="btn-save-key" onclick="saveFinnhubKey()">저장</button>
                </div>
                <div class="test-result" id="apiTestResult"></div>
                <p class="admin-hint">finnhub.io에서 무료 API 키를 발급받으세요</p>
            </div>
            <div class="sheet-section">
                <div class="sheet-section-title">주식 추가</div>
                <div class="admin-form">
                    <input type="text" id="stockSymbolInput" placeholder="종목코드 (예: PLTR)" autocapitalize="characters">
                    <input type="number" id="stockSharesInput" placeholder="수량" min="1" style="max-width:100px;">
                    <button onclick="addStock()">추가</button>
                </div>
                <p class="admin-hint">미국 주식 티커 심볼 입력 (예: PLTR, AAPL, TSLA, MSFT, NVDA)</p>
            </div>
            <div class="sheet-section">
                <div class="sheet-section-title">보유 종목</div>
                <ul class="admin-stock-list" id="adminStockList">
                    <li class="asset-empty">등록된 종목이 없습니다</li>
                </ul>
            </div>
            <div class="sheet-section">
                <div class="sheet-section-title">현금 자산 (KRW)</div>
                <div class="cash-form">
                    <input type="number" id="cashInput" placeholder="원화 금액 입력" min="0" step="1">
                </div>
            </div>
            <div class="sheet-section">
                <div class="sheet-section-title">D-Day 이벤트</div>
                <div id="adminEventCurrent"></div>
                <div class="admin-event-form">
                    <input type="text" id="eventTitleInput" placeholder="이벤트 제목 (예: 바디프로필 촬영)">
                    <input type="date" id="eventDateInput">
                </div>
                <div class="admin-event-actions">
                    <button style="background:var(--primary-gradient);color:white;" onclick="saveEvent()">등록하기</button>
                </div>
            </div>
            <div class="sheet-section">
                <div class="sheet-section-title">회원 관리</div>
                <ul class="admin-stock-list" id="adminUserList">
                    <li class="asset-empty">로딩 중...</li>
                </ul>
            </div>
            <div class="sheet-section" style="padding-top:8px; border-top: 2px solid var(--border);">
                <button class="btn-save-all" onclick="saveAll()">저장하기</button>
                <div class="save-all-result" id="saveAllResult"></div>
            </div>
        </div>
    </div>

    <script>
        // 상태
        let currentUser = null;
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let calendarData = null;
        let todayCompleted = false;
        let rankingExpanded = false;
        let deferredPrompt = null;
        let assetRefreshTimer = null;

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 저장된 로그인 정보 확인 (localStorage - 영구 저장)
            const savedUser = localStorage.getItem('pushupUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainScreen();
                } catch (e) {
                    localStorage.removeItem('pushupUser');
                }
            }

            // 오늘 날짜 표시
            updateTodayDate();

            // 엔터 키로 로그인
            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });

        // 오늘 날짜 업데이트
        function updateTodayDate() {
            const today = new Date();
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('ko-KR', options);
        }

        // 로그인
        async function login() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('이름을 입력해주세요');
                nameInput.focus();
                return;
            }

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (!res.ok) {
                    const error = await res.json();
                    showToast(error.error || '로그인 실패');
                    return;
                }

                currentUser = await res.json();
                // localStorage에 저장 (브라우저 종료 후에도 유지)
                localStorage.setItem('pushupUser', JSON.stringify(currentUser));
                showMainScreen();
                showToast(`${currentUser.name}님, 환영합니다!`);
            } catch (err) {
                showToast('서버 연결에 실패했습니다');
            }
        }

        // 로그아웃
        function logout() {
            localStorage.removeItem('pushupUser');
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('nameInput').value = '';
        }

        // 메인 화면 표시
        async function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').classList.add('active');

            // 유저 정보 표시
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);

            // 관리자 버튼 표시
            document.getElementById('adminBtn').style.display = currentUser.is_admin ? 'flex' : 'none';

            await loadMonthOptions();
            await Promise.all([loadCalendar(), loadRanking(), loadAssets(), loadEvent()]);

            // 1분마다 자산 갱신
            if (assetRefreshTimer) clearInterval(assetRefreshTimer);
            assetRefreshTimer = setInterval(loadAssets, 60000);
        }

        // 월 옵션 로드
        async function loadMonthOptions() {
            try {
                const res = await fetch('/api/available-months');
                const months = await res.json();

                const select = document.getElementById('monthSelect');
                select.innerHTML = months.map(m =>
                    `<option value="${m.year}-${m.month}" ${m.year === currentYear && m.month === currentMonth ? 'selected' : ''}>${m.label}</option>`
                ).join('');
            } catch (err) {
                console.error('월 목록 로드 실패:', err);
            }
        }

        // 캘린더 로드
        async function loadCalendar() {
            const [year, month] = document.getElementById('monthSelect').value.split('-').map(Number);
            currentYear = year;
            currentMonth = month;

            try {
                const res = await fetch(`/api/calendar/${year}/${month}?user_id=${currentUser.id}`);
                calendarData = await res.json();

                renderCalendar();
                updateStats();
                updateTodayAction();
                await loadRanking();
            } catch (err) {
                console.error('캘린더 로드 실패:', err);
                showToast('데이터 로드에 실패했습니다');
            }
        }

        // 통계 업데이트
        function updateStats() {
            const { penalty, missed_days, total_workdays } = calendarData;
            const completedDays = total_workdays - missed_days;
            const rate = total_workdays > 0 ? Math.round(completedDays / total_workdays * 100) : 0;

            document.getElementById('penaltyAmount').textContent = '₩' + penalty.toLocaleString();
            document.getElementById('completedDays').textContent = completedDays;
            document.getElementById('missedDays').textContent = missed_days;
            document.getElementById('totalWorkdays').textContent = total_workdays;
            document.getElementById('completionBadge').textContent = rate + '%';
        }

        // 오늘 액션 업데이트
        function updateTodayAction() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            const isCurrentMonth = currentYear === today.getFullYear() && currentMonth === today.getMonth() + 1;
            const actionEl = document.getElementById('todayAction');
            const btnEl = document.getElementById('todayBtn');
            const iconEl = document.getElementById('todayIcon');
            const titleEl = document.getElementById('todayTitle');

            if (!isCurrentMonth) {
                actionEl.style.display = 'none';
                return;
            }

            actionEl.style.display = 'block';
            todayCompleted = calendarData.completed_dates.includes(todayStr);

            // 오늘이 평일인지 확인
            const dayOfWeek = today.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isHoliday = calendarData.holidays.some(h => h.date === todayStr);
            const isWorkday = !isWeekend && !isHoliday;

            actionEl.classList.remove('completed', 'not-workday');

            if (!isWorkday) {
                actionEl.classList.add('not-workday');
                iconEl.textContent = '🎉';
                titleEl.textContent = '오늘은 휴일!';
                btnEl.textContent = '푸쉬업 안해도 돼요';
                btnEl.disabled = true;
            } else if (todayCompleted) {
                actionEl.classList.add('completed');
                iconEl.textContent = '✅';
                titleEl.textContent = '오늘 완료!';
                btnEl.textContent = '취소하기';
                btnEl.disabled = false;
            } else {
                iconEl.textContent = '💪';
                titleEl.textContent = '오늘의 푸시업';
                btnEl.textContent = '100개 완료하기';
                btnEl.disabled = false;
            }
        }

        // 계좌번호 복사
        function copyAccount() {
            const account = '7942-14-57728';
            navigator.clipboard.writeText(account).then(() => {
                showToast('계좌번호가 복사되었습니다');
            }).catch(() => {
                // fallback
                const ta = document.createElement('textarea');
                ta.value = account;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('계좌번호가 복사되었습니다');
            });
        }

        // 오늘 토글
        async function toggleToday() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            await toggleDay(todayStr);
        }

        // 날짜 토글 (과거/오늘 모두 가능)
        async function toggleDay(dateStr) {
            try {
                const res = await fetch('/api/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        date: dateStr
                    })
                });

                if (!res.ok) {
                    const error = await res.json();
                    showToast(error.error || '처리 실패');
                    return;
                }

                const result = await res.json();

                if (result.completed) {
                    showToast('🎉 100개 완료! 대단해요!');
                } else {
                    showToast('기록이 취소되었습니다');
                }

                await loadCalendar();
            } catch (err) {
                showToast('서버 연결에 실패했습니다');
            }
        }

        // 캘린더 렌더링
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const { year, month, completed_dates, holidays, first_day_weekday, last_day } = calendarData;

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            const holidayDates = holidays.map(h => h.date);
            const startDay = (first_day_weekday + 1) % 7;

            let html = '';

            // 빈 칸
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // 날짜
            for (let day = 1; day <= last_day; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = (startDay + day - 1) % 7;

                const isToday = dateStr === todayStr;
                const isCompleted = completed_dates.includes(dateStr);
                const isHoliday = holidayDates.includes(dateStr);
                const isSunday = dayOfWeek === 0;
                const isSaturday = dayOfWeek === 6;
                const isWeekend = isSunday || isSaturday;

                const dateObj = new Date(year, month - 1, day);
                const isFuture = dateObj > today;
                const isPast = dateObj < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const isWorkday = !isWeekend && !isHoliday;
                const isMissed = isPast && isWorkday && !isCompleted;

                let classes = ['calendar-day'];
                if (isToday) classes.push('today');
                if (isCompleted) classes.push('completed');
                else if (isHoliday) classes.push('holiday');
                else if (isSunday) classes.push('sunday');
                else if (isSaturday) classes.push('saturday');
                if (isFuture) classes.push('future');
                if (isMissed) classes.push('missed');

                // 미래가 아니면 클릭 가능
                const clickable = !isFuture ? `onclick="toggleDay('${dateStr}')"` : '';

                html += `<div class="${classes.join(' ')}" ${clickable}>${day}</div>`;
            }

            grid.innerHTML = html;
        }

        // 랭킹 로드
        async function loadRanking() {
            const list = document.getElementById('rankingList');
            rankingExpanded = false;

            try {
                const res = await fetch(`/api/ranking?year=${currentYear}&month=${currentMonth}`);
                const rankings = await res.json();

                if (rankings.length === 0) {
                    list.innerHTML = '<li class="empty-state"><p>아직 참가자가 없습니다</p></li>';
                    return;
                }

                const VISIBLE_COUNT = 3;
                const hasMore = rankings.length > VISIBLE_COUNT;

                let html = rankings.map((r, index) => {
                    const isMe = currentUser && r.id === currentUser.id;
                    const rankClass = r.rank <= 3 ? `rank-${r.rank}` : '';
                    const meClass = isMe ? 'is-me' : '';
                    const penaltyClass = r.penalty === 0 ? 'zero' : '';
                    const hiddenClass = index >= VISIBLE_COUNT ? 'hidden' : '';

                    return `
                        <li class="ranking-item ${rankClass} ${meClass} ${hiddenClass}" data-rank-index="${index}">
                            <div class="rank-badge">${r.rank}</div>
                            <div class="rank-info">
                                <div class="rank-name">${r.name}${isMe ? ' (나)' : ''}</div>
                                <div class="rank-stats">${r.completed_days}/${r.total_workdays}일 • ${r.completion_rate}%</div>
                            </div>
                            <div class="rank-penalty">
                                <div class="penalty-amount ${penaltyClass}">₩${r.penalty.toLocaleString()}</div>
                                <div class="penalty-label">벌금</div>
                            </div>
                        </li>
                    `;
                }).join('');

                if (hasMore) {
                    html += `
                        <button class="ranking-toggle" id="rankingToggle" onclick="toggleRanking()">
                            <span>더보기 (${rankings.length - VISIBLE_COUNT}명)</span>
                            <span class="arrow">▼</span>
                        </button>
                    `;
                }

                list.innerHTML = html;
            } catch (err) {
                console.error('랭킹 로드 실패:', err);
                list.innerHTML = '<li class="empty-state"><p>랭킹을 불러올 수 없습니다</p></li>';
            }
        }

        // 랭킹 더보기/접기
        function toggleRanking() {
            rankingExpanded = !rankingExpanded;
            const items = document.querySelectorAll('.ranking-item[data-rank-index]');
            const toggleBtn = document.getElementById('rankingToggle');
            const VISIBLE_COUNT = 3;

            items.forEach((item, index) => {
                if (index >= VISIBLE_COUNT) {
                    item.classList.toggle('hidden', !rankingExpanded);
                }
            });

            if (toggleBtn) {
                toggleBtn.classList.toggle('expanded', rankingExpanded);
                const count = items.length - VISIBLE_COUNT;
                toggleBtn.innerHTML = rankingExpanded
                    ? '<span>접기</span><span class="arrow">▼</span>'
                    : `<span>더보기 (${count}명)</span><span class="arrow">▼</span>`;
            }
        }

        // 자산 로드
        async function loadAssets() {
            try {
                const res = await fetch('/api/assets');
                const data = await res.json();

                // 총 자산 (KRW)
                document.getElementById('assetTotalAmount').textContent = '₩' + data.total_assets_krw.toLocaleString();

                // 환율 정보
                const rateInfo = document.getElementById('exchangeRateInfo');
                if (data.usd_krw) {
                    rateInfo.textContent = '환율: 1 USD = ₩' + data.usd_krw.toLocaleString() + ' KRW';
                    rateInfo.style.display = 'block';
                } else {
                    rateInfo.style.display = 'none';
                }

                // 주식 업데이트 시간
                if (data.updated_at) {
                    document.getElementById('stockUpdateTime').textContent = data.updated_at + ' 업데이트';
                }

                // 주식 목록
                const stockList = document.getElementById('stockList');
                if (data.stocks.length === 0) {
                    stockList.innerHTML = '<li class="asset-empty">등록된 종목이 없습니다</li>';
                } else {
                    stockList.innerHTML = data.stocks.map(s => {
                        const changeClass = s.change_percent > 0 ? 'positive' : s.change_percent < 0 ? 'negative' : 'zero';
                        const changeSign = s.change_percent > 0 ? '+' : '';
                        return `
                            <li class="stock-item">
                                <div>
                                    <div class="stock-symbol">${s.symbol}</div>
                                    <div class="stock-shares">${s.shares}주 × $${s.current_price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="stock-right">
                                    <div class="stock-value">₩${s.value_krw.toLocaleString()}</div>
                                    <div class="stock-change ${changeClass}">${changeSign}${s.change_percent}%</div>
                                </div>
                            </li>
                        `;
                    }).join('');
                }

                // 현금 (KRW)
                document.getElementById('cashAmount').textContent = '₩' + data.cash_krw.toLocaleString();

                // 갱신 시간 (헤더)
                const now = new Date();
                document.getElementById('assetRefreshTime').textContent = now.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}) + ' 갱신';

                // 관리자 모달의 주식 목록도 갱신
                renderAdminStockList(data.stocks);
                // 현금 입력란에 현재값 설정
                const cashInput = document.getElementById('cashInput');
                if (cashInput && !cashInput.matches(':focus')) {
                    cashInput.value = data.cash_krw || '';
                }
            } catch (err) {
                console.error('자산 로드 실패:', err);
            }
        }

        // API 키 상태 로드
        async function loadApiKeyStatus() {
            try {
                const res = await fetch(`/api/admin/finnhub-key?user_id=${currentUser.id}`);
                if (!res.ok) return;
                const data = await res.json();
                const dot = document.getElementById('apiKeyDot');
                const text = document.getElementById('apiKeyStatusText');
                if (data.has_key) {
                    dot.className = 'api-key-dot connected';
                    text.textContent = '설정됨: ' + data.masked_key;
                } else {
                    dot.className = 'api-key-dot disconnected';
                    text.textContent = '키 미설정';
                }
            } catch (err) {
                console.error('API 키 상태 로드 실패:', err);
            }
        }

        // Finnhub API 키 연결 테스트
        async function testFinnhubKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const resultEl = document.getElementById('apiTestResult');
            resultEl.className = 'test-result';
            resultEl.style.display = 'block';
            resultEl.textContent = '테스트 중...';
            resultEl.style.background = 'var(--gray-100)';
            resultEl.style.color = 'var(--gray-600)';

            try {
                const res = await fetch('/api/admin/finnhub-test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, api_key: apiKey || ''})
                });
                const data = await res.json();
                if (data.success) {
                    resultEl.className = 'test-result success';
                    resultEl.textContent = data.message;
                } else {
                    resultEl.className = 'test-result error';
                    resultEl.textContent = data.message;
                }
            } catch (err) {
                resultEl.className = 'test-result error';
                resultEl.textContent = '연결 실패: 네트워크 오류';
            }
        }

        // Finnhub API 키 저장
        async function saveFinnhubKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showToast('API 키를 입력해주세요');
                return;
            }

            try {
                const res = await fetch('/api/admin/finnhub-key', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, api_key: apiKey})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.error || '저장 실패');
                    return;
                }
                const resultEl = document.getElementById('apiTestResult');
                resultEl.className = 'test-result success';
                resultEl.textContent = '저장 완료!';
                document.getElementById('apiKeyInput').value = '';
                await loadApiKeyStatus();
                await loadAssets();
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 회원 목록 로드
        async function loadUsers() {
            try {
                const res = await fetch(`/api/admin/users?user_id=${currentUser.id}`);
                if (!res.ok) return;
                const users = await res.json();
                const list = document.getElementById('adminUserList');
                if (users.length === 0) {
                    list.innerHTML = '<li class="asset-empty">회원이 없습니다</li>';
                    return;
                }
                list.innerHTML = users.map(u => `
                    <li class="admin-stock-item">
                        <div class="admin-stock-info">${u.name}${u.is_admin ? ' (관리자)' : ''}<br><span style="font-size:0.75rem;color:var(--text-muted);">${u.created_at} 가입</span></div>
                        ${u.is_admin ? '' : `<div class="admin-stock-actions"><button class="btn-delete" onclick="deleteUser(${u.id}, '${u.name}')">삭제</button></div>`}
                    </li>
                `).join('');
            } catch (err) {
                console.error('회원 목록 로드 실패:', err);
            }
        }

        // 회원 삭제
        async function deleteUser(id, name) {
            if (!confirm(`${name}님을 정말 삭제하시겠습니까?\n해당 회원의 모든 기록이 삭제됩니다.`)) return;
            try {
                const res = await fetch(`/api/admin/user/${id}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id})
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showToast(data.message);
                    await loadUsers();
                    await loadRanking();
                } else {
                    showToast(data.error || '삭제 실패');
                }
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 관리자 모달 열기
        function openAdminSheet() {
            document.getElementById('adminOverlay').classList.add('show');
            document.getElementById('adminSheet').classList.add('show');
            loadAssets();
            loadApiKeyStatus();
            loadUsers();
            loadAdminEventStatus();
        }

        // 관리자 모달 닫기
        function closeAdminSheet() {
            document.getElementById('adminOverlay').classList.remove('show');
            document.getElementById('adminSheet').classList.remove('show');
        }

        // 관리자 주식 목록 렌더링
        function renderAdminStockList(stocks) {
            const list = document.getElementById('adminStockList');
            if (!stocks || stocks.length === 0) {
                list.innerHTML = '<li class="asset-empty">등록된 종목이 없습니다</li>';
                return;
            }
            list.innerHTML = stocks.map(s => `
                <li class="admin-stock-item">
                    <div class="admin-stock-info">${s.symbol} - ${s.shares}주</div>
                    <div class="admin-stock-actions">
                        <button class="btn-edit" onclick="editStock(${s.id}, '${s.symbol}', ${s.shares})">수정</button>
                        <button class="btn-delete" onclick="deleteStock(${s.id}, '${s.symbol}')">삭제</button>
                    </div>
                </li>
            `).join('');
        }

        // 주식 추가
        async function addStock() {
            const symbol = document.getElementById('stockSymbolInput').value.trim().toUpperCase();
            const shares = parseInt(document.getElementById('stockSharesInput').value);

            if (!symbol) { showToast('종목코드를 입력해주세요'); return; }
            if (!shares || shares <= 0) { showToast('수량을 올바르게 입력해주세요'); return; }

            try {
                const res = await fetch('/api/admin/stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, symbol, shares})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.error || '추가 실패');
                    return;
                }
                document.getElementById('stockSymbolInput').value = '';
                document.getElementById('stockSharesInput').value = '';
                showToast(`${symbol} ${shares}주 추가 완료`);
                await loadAssets();
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 주식 수정
        async function editStock(id, symbol, currentShares) {
            const newShares = prompt(`${symbol} 수량 변경 (현재: ${currentShares}주)`, currentShares);
            if (newShares === null) return;
            const shares = parseInt(newShares);
            if (!shares || shares <= 0) { showToast('올바른 수량을 입력해주세요'); return; }

            try {
                const res = await fetch(`/api/admin/stock/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, shares})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.error || '수정 실패');
                    return;
                }
                showToast(`${symbol} 수량 변경 완료`);
                await loadAssets();
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 주식 삭제
        async function deleteStock(id, symbol) {
            if (!confirm(`${symbol}을(를) 삭제하시겠습니까?`)) return;

            try {
                const res = await fetch(`/api/admin/stock/${id}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.error || '삭제 실패');
                    return;
                }
                showToast(`${symbol} 삭제 완료`);
                await loadAssets();
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 현금 수정 (개별)
        async function updateCash() {
            const amount = parseInt(document.getElementById('cashInput').value);
            if (isNaN(amount) || amount < 0) { showToast('올바른 금액을 입력해주세요'); return; }

            try {
                const res = await fetch('/api/admin/cash', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, amount})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.error || '저장 실패');
                    return;
                }
                showToast('현금 자산 저장 완료');
                await loadAssets();
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 전체 저장
        async function saveAll() {
            const resultEl = document.getElementById('saveAllResult');
            resultEl.className = 'save-all-result';
            resultEl.style.display = 'block';
            resultEl.style.background = 'var(--gray-100)';
            resultEl.style.color = 'var(--gray-600)';
            resultEl.textContent = '저장 중...';

            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const cashAmount = document.getElementById('cashInput').value;

            try {
                const res = await fetch('/api/admin/save-all', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        api_key: apiKey || '',
                        cash_amount: cashAmount || 0
                    })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    resultEl.className = 'save-all-result success';
                    resultEl.textContent = data.message;
                    if (apiKey) {
                        document.getElementById('apiKeyInput').value = '';
                        await loadApiKeyStatus();
                    }
                    await loadAssets();
                    setTimeout(() => { resultEl.style.display = 'none'; }, 3000);
                } else {
                    resultEl.className = 'save-all-result error';
                    resultEl.textContent = data.error || '저장 실패';
                }
            } catch (err) {
                resultEl.className = 'save-all-result error';
                resultEl.textContent = '서버 연결 실패';
            }
        }

        // 토스트 메시지
        function showToast(message) {
            if (!message) return;
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // ===== D-Day 이벤트 기능 =====
        let currentEvent = null;

        // 이벤트 로드 (공지바 업데이트)
        async function loadEvent() {
            try {
                const res = await fetch(`/api/event?user_id=${currentUser.id}`);
                const data = await res.json();
                const bar = document.getElementById('noticeBar');

                if (!data.event) {
                    bar.classList.add('hidden');
                    currentEvent = null;
                    return;
                }

                currentEvent = data.event;
                bar.classList.remove('hidden');
                document.getElementById('noticeDday').textContent = currentEvent.d_day;
                document.getElementById('noticeText').textContent = currentEvent.title;
            } catch (err) {
                console.error('이벤트 로드 실패:', err);
            }
        }

        // 이벤트 상세 화면 보기
        function showEventScreen() {
            if (!currentEvent) return;
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('eventScreen').classList.add('active');
            renderEventDetail();
        }

        // 홈으로 돌아가기
        function hideEventScreen() {
            document.getElementById('eventScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.add('active');
        }

        // 이벤트 상세 렌더링
        async function renderEventDetail() {
            // 최신 데이터 다시 로드
            try {
                const res = await fetch(`/api/event?user_id=${currentUser.id}`);
                const data = await res.json();
                if (!data.event) {
                    hideEventScreen();
                    return;
                }
                currentEvent = data.event;
            } catch (err) {
                console.error('이벤트 로드 실패:', err);
                return;
            }

            const ev = currentEvent;
            document.getElementById('eventDdayLarge').textContent = ev.d_day;
            document.getElementById('eventTitleLarge').textContent = ev.title;

            const targetDate = new Date(ev.target_date + 'T00:00:00');
            const dateStr = targetDate.toLocaleDateString('ko-KR', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'});
            document.getElementById('eventDateInfo').textContent = dateStr;

            // 참석/취소 버튼
            const joinBtn = document.getElementById('eventJoinBtn');
            if (ev.my_joined) {
                joinBtn.textContent = '취소하기';
                joinBtn.classList.add('joined');
            } else {
                joinBtn.textContent = '참석하기';
                joinBtn.classList.remove('joined');
            }

            // 참석자 목록
            document.getElementById('eventParticipantCount').textContent = ev.participant_count + '명';
            const list = document.getElementById('eventParticipantList');

            if (ev.participants.length === 0) {
                list.innerHTML = '<li class="event-participant-empty">아직 참석자가 없습니다</li>';
            } else {
                list.innerHTML = ev.participants.map(p => {
                    const isMe = currentUser && p.id === currentUser.id;
                    return `
                        <li class="event-participant-item ${isMe ? 'is-me' : ''}">
                            <div class="event-participant-avatar">${p.name.charAt(0)}</div>
                            <div class="event-participant-name">${p.name}${isMe ? ' (나)' : ''}</div>
                            <div class="event-participant-date">${p.joined_at}</div>
                        </li>
                    `;
                }).join('');
            }
        }

        // 참석/취소 토글
        async function toggleEventJoin() {
            if (!currentEvent) return;

            const isJoined = currentEvent.my_joined;
            const url = isJoined ? '/api/event/leave' : '/api/event/join';

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, event_id: currentEvent.id})
                });

                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.error || '처리 실패');
                    return;
                }

                showToast(isJoined ? '참석이 취소되었습니다' : '참석 등록 완료!');
                await renderEventDetail();
                await loadEvent();
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 관리자: 이벤트 저장
        async function saveEvent() {
            const title = document.getElementById('eventTitleInput').value.trim();
            const targetDate = document.getElementById('eventDateInput').value;

            if (!title || !targetDate) {
                showToast('제목과 날짜를 입력해주세요');
                return;
            }

            try {
                const res = await fetch('/api/admin/event', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, title, target_date: targetDate})
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showToast('이벤트가 등록되었습니다');
                    document.getElementById('eventTitleInput').value = '';
                    document.getElementById('eventDateInput').value = '';
                    await loadEvent();
                    loadAdminEventStatus();
                } else {
                    showToast(data.error || '등록 실패');
                }
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 관리자: 이벤트 삭제
        async function deleteEvent(eventId) {
            if (!confirm('이벤트를 삭제하시겠습니까?\n참석자 명단도 함께 삭제됩니다.')) return;

            try {
                const res = await fetch(`/api/admin/event/${eventId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser.id})
                });
                if (res.ok) {
                    showToast('이벤트 삭제 완료');
                    await loadEvent();
                    loadAdminEventStatus();
                }
            } catch (err) {
                showToast('서버 연결 실패');
            }
        }

        // 관리자: 현재 이벤트 상태 표시
        async function loadAdminEventStatus() {
            const container = document.getElementById('adminEventCurrent');
            try {
                const res = await fetch(`/api/event?user_id=${currentUser.id}`);
                const data = await res.json();
                if (data.event) {
                    const ev = data.event;
                    container.innerHTML = `
                        <div class="admin-event-current">
                            <div class="admin-event-current-info">
                                ${ev.d_day} ${ev.title}
                                <span>${ev.target_date} | 참석 ${ev.participant_count}명</span>
                            </div>
                            <button class="btn-delete" style="padding:7px 14px;border:none;border-radius:8px;font-size:0.8rem;font-weight:600;cursor:pointer;background:var(--danger-light);color:var(--danger);" onclick="deleteEvent(${ev.id})">삭제</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="font-size:0.825rem;color:var(--text-muted);margin-bottom:10px;">등록된 이벤트 없음</p>';
                }
            } catch (err) {
                container.innerHTML = '';
            }
        }

        // PWA 서비스 워커 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    await navigator.serviceWorker.register('/service-worker.js');
                    console.log('Service Worker 등록 완료');
                } catch (err) {
                    console.log('Service Worker 등록 실패:', err);
                }
            });
        }

        // PWA 설치 프롬프트 처리
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // 이전에 닫은 적이 있으면 3일 후에 다시 표시
            const dismissedAt = localStorage.getItem('pwaDismissedAt');
            if (dismissedAt) {
                const daysSinceDismissed = (Date.now() - parseInt(dismissedAt)) / (1000 * 60 * 60 * 24);
                if (daysSinceDismissed < 3) return;
            }

            // 이미 설치된 경우 표시하지 않음
            if (window.matchMedia('(display-mode: standalone)').matches) return;

            // 1.5초 후 배너 표시
            setTimeout(() => {
                showPWABanner();
            }, 1500);
        });

        // PWA 배너 표시
        function showPWABanner() {
            const banner = document.getElementById('pwaBanner');
            banner.classList.add('show');
        }

        // PWA 배너 숨기기
        function hidePWABanner() {
            const banner = document.getElementById('pwaBanner');
            banner.classList.remove('show');
        }

        // PWA 설치 버튼 클릭
        document.getElementById('pwaInstallBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return;

            hidePWABanner();
            deferredPrompt.prompt();

            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showToast('앱이 설치되었습니다! 🎉');
            }
            deferredPrompt = null;
        });

        // PWA 나중에 버튼 클릭
        document.getElementById('pwaDismissBtn').addEventListener('click', () => {
            hidePWABanner();
            localStorage.setItem('pwaDismissedAt', Date.now().toString());
        });

        // 이미 설치된 앱에서 실행 시
        window.addEventListener('appinstalled', () => {
            hidePWABanner();
            deferredPrompt = null;
            showToast('홈 화면에 추가되었습니다!');
        });
    </script>
</body>
</html>
